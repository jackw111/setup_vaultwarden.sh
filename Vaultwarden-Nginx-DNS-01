#!/bin/bash

# ==============================================================================
# Vaultwarden & Nginx (DNS-01 & è‡ªå®šä¹‰ç«¯å£ç»ˆæç‰ˆ - Snap Certbot)
#
# v2.0 æ›´æ–°:
# - ã€æ–°ã€‘å¢åŠ æœåŠ¡å™¨æ—¶é—´å¼ºåˆ¶åŒæ­¥åŠŸèƒ½ã€‚
# - ã€æ–°ã€‘Nginx é…ç½®å¢åŠ  IP è®¿é—®æ‹¦æˆªï¼Œæå‡å®‰å…¨æ€§ã€‚
#
# ä½¿ç”¨ Snap å®‰è£…æœ€æ–°ç‰ˆ Certbot ä»¥è§£å†³ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜ã€‚
# ä½¿ç”¨ Certbot çš„ DNS-01 (Cloudflare) æ’ä»¶ç”³è¯·SSLè¯ä¹¦ã€‚
# ==============================================================================

# --- é…ç½®é¢œè‰²è¾“å‡º ---
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# --- å‡½æ•°å®šä¹‰ ---

# æ£€æŸ¥è„šæœ¬æ˜¯å¦ä»¥ root æƒé™è¿è¡Œ
check_root() {
    if [ "$EUID" -ne 0 ]; then
        echo -e "${RED}é”™è¯¯: è¯·ä½¿ç”¨ sudo æˆ–ä»¥ root ç”¨æˆ·èº«ä»½è¿è¡Œæ­¤è„šæœ¬ã€‚${NC}"
        exit 1
    fi
}

# æ£€æŸ¥å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œ
check_success() {
    if [ $? -ne 0 ]; then
        echo -e "${RED}é”™è¯¯: ä¸Šä¸€æ­¥æ“ä½œå¤±è´¥ï¼Œè„šæœ¬å·²ç»ˆæ­¢ã€‚è¯·æ£€æŸ¥è¾“å‡ºä¿¡æ¯ã€‚${NC}"
        exit 1
    fi
}

# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ (é™¤äº†Nginxè‡ªèº«)
check_port() {
    local port=$1
    if ss -tlnp | grep -q ":${port} "; then
        echo -e "${RED}é”™è¯¯: ç«¯å£ ${port} å·²è¢«å ç”¨ï¼Œè¯·æ›´æ¢ç«¯å£æˆ–åœæ­¢å ç”¨è¯¥ç«¯å£çš„ç¨‹åºã€‚${NC}"
        exit 1
    fi
}

# ã€æ–°åŠŸèƒ½ã€‘æ ¡å‡†æœåŠ¡å™¨æ—¶é—´
sync_system_time() {
    echo -e "${GREEN}>>> æ­£åœ¨æ ¡å‡†æœåŠ¡å™¨æ—¶é—´...${NC}"
    # ä½¿ç”¨ timedatectlï¼Œè¿™æ˜¯ç°ä»£ systemd ç³»ç»Ÿçš„æ ‡å‡†æ–¹å¼
    if command -v timedatectl &> /dev/null; then
        timedatectl set-ntp true
        check_success
        echo -e "${YELLOW}--> å·²å¯ç”¨å¹¶è§¦å‘ç½‘ç»œæ—¶é—´åŒæ­¥ (NTP)ã€‚${NC}"
        sleep 2 # ç­‰å¾…åŒæ­¥æ“ä½œç”Ÿæ•ˆ
        echo -e "${YELLOW}--> å½“å‰æœåŠ¡å™¨æ—¶é—´: $(date)${NC}"
    else
        echo -e "${YELLOW}è­¦å‘Š: æœªæ‰¾åˆ° timedatectl å‘½ä»¤ã€‚å¯¹äºé systemd ç³»ç»Ÿï¼Œè¯·æ‰‹åŠ¨é…ç½® NTPã€‚${NC}"
    fi
}

# å®‰è£… Certbot (Snap æ–¹å¼)
install_certbot_snap() {
    echo -e "${GREEN}>>> æ­£åœ¨ä½¿ç”¨ Snap å®‰è£…æœ€æ–°ç‰ˆçš„ Certbot...${NC}"
    if ! command -v snap &> /dev/null; then
        echo -e "${YELLOW}--> Snapd æœªå®‰è£…ï¼Œæ­£åœ¨å®‰è£…...${NC}"
        apt-get update
        apt-get install -y snapd
        check_success
    fi
    if [ ! -S /run/snapd.socket ]; then
      systemctl enable --now snapd.socket
    fi
    sleep 5
    echo -e "${YELLOW}--> æ­£åœ¨å¸è½½æ—§çš„ apt/yum ç‰ˆæœ¬ Certbot (å¦‚æœ‰)...${NC}"
    apt-get remove -y certbot python3-certbot-dns-cloudflare
    echo -e "${YELLOW}--> æ­£åœ¨é€šè¿‡ Snap å®‰è£… Certbot æ ¸å¿ƒç¨‹åº...${NC}"
    snap install core && snap refresh core
    snap install --classic certbot
    check_success
    echo -e "${YELLOW}--> æ­£åœ¨åˆ›å»º certbot å‘½ä»¤çš„ç¬¦å·é“¾æ¥...${NC}"
    ln -sfn /snap/bin/certbot /usr/bin/certbot
    echo -e "${YELLOW}--> æ­£åœ¨é€šè¿‡ Snap å®‰è£… Certbot çš„ Cloudflare DNS æ’ä»¶...${NC}"
    snap set certbot trust-plugin-with-root=ok
    snap install certbot-dns-cloudflare
    check_success
    echo -e "${GREEN}>>> Certbot (Snap) å®‰è£…å’Œé…ç½®å®Œæˆã€‚${NC}"
}

# å®‰è£…ç³»ç»Ÿä¾èµ–
install_dependencies() {
    echo -e "${GREEN}>>> 1. æ­£åœ¨æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ä¾èµ–...${NC}"
    apt-get update
    check_success
    
    # ã€æ–°åŠŸèƒ½è°ƒç”¨ã€‘é¦–å…ˆåŒæ­¥æ—¶é—´
    sync_system_time

    apt-get install -y docker.io docker-compose nginx curl openssl
    check_success
    systemctl enable --now docker && systemctl enable --now nginx
    check_success
    install_certbot_snap
    echo -e "${GREEN}>>> ä¾èµ–å®‰è£…å®Œæˆã€‚${NC}"
}

get_user_input() {
    echo -e "${GREEN}>>> 2. è¯·è¾“å…¥é…ç½®ä¿¡æ¯...${NC}"
    while [ -z "$DOMAIN_NAME" ]; do
        read -p "è¯·è¾“å…¥ä½ çš„åŸŸå (ç¡®ä¿DNSç”±Cloudflareç®¡ç†): " DOMAIN_NAME
    done
    while [ -z "$EMAIL" ]; do
        read -p "è¯·è¾“å…¥ä½ çš„é‚®ç®± (ç”¨äº Let's Encrypt è¯ä¹¦æé†’): " EMAIL
    done
    while [ -z "$CLOUDFLARE_API_TOKEN" ]; do
        read -p "è¯·è¾“å…¥ä½ çš„ Cloudflare API Token (å…·æœ‰DNSç¼–è¾‘æƒé™): " CLOUDFLARE_API_TOKEN
    done
    read -p "è¯·è¾“å…¥ä½ å¸Œæœ›ç”¨äºHTTPè®¿é—®çš„ç«¯å£ (ä¾‹å¦‚ 8081, å°†é‡å®šå‘åˆ°HTTPS) [8081]: " HTTP_PORT
    HTTP_PORT=${HTTP_PORT:-8081}
    read -p "è¯·è¾“å…¥ä½ å¸Œæœ›ç”¨äºHTTPSè®¿é—®çš„ç«¯å£ (ä¾‹å¦‚ 8443) [8443]: " HTTPS_PORT
    HTTPS_PORT=${HTTPS_PORT:-8443}
    check_port $HTTP_PORT
    check_port $HTTPS_PORT
}

setup_vaultwarden() {
    echo -e "${GREEN}>>> 3. æ­£åœ¨é…ç½®å¹¶å¯åŠ¨ Vaultwarden å®¹å™¨...${NC}"
    mkdir -p /opt/vaultwarden
    cd /opt/vaultwarden
    ADMIN_TOKEN=$(openssl rand -base64 48)
    cat <<EOF > docker-compose.yml
version: '3'
services:
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: always
    ports:
      - "127.0.0.1:8080:80"
      - "127.0.0.1:3012:3012"
    environment:
      - WEBSOCKET_ENABLED=true
      - ADMIN_TOKEN=\${ADMIN_TOKEN}
    volumes:
      - ./vw-data:/data
EOF
    check_success
    echo -e "${YELLOW}--> æ­£åœ¨åˆ›å»º .env æ–‡ä»¶ä»¥å®‰å…¨åœ°å­˜å‚¨ç®¡ç†å‘˜ä»¤ç‰Œ...${NC}"
    cat <<EOF > .env
ADMIN_TOKEN=${ADMIN_TOKEN}
EOF
    check_success
    chmod 600 .env
    docker-compose up -d --force-recreate
    check_success
    echo -e "${YELLOW}ç­‰å¾… 10 ç§’é’Ÿï¼Œç¡®ä¿ Vaultwarden æœåŠ¡å®Œå…¨å¯åŠ¨...${NC}"
    sleep 10
    echo -e "${GREEN}>>> Vaultwarden å®¹å™¨å·²æˆåŠŸå¯åŠ¨ã€‚${NC}"
}

# é…ç½® Nginx å’Œ SSL
setup_nginx_ssl() {
    echo -e "${GREEN}>>> 4. æ­£åœ¨é…ç½® Nginx å¹¶ä½¿ç”¨ DNS-01 æ–¹å¼ç”³è¯· SSL è¯ä¹¦...${NC}"
    echo -e "${YELLOW}--> æ­¥éª¤ 4.1: åˆ›å»º Cloudflare å‡­è¯æ–‡ä»¶...${NC}"
    mkdir -p /etc/letsencrypt/cloudflare
    echo -n "dns_cloudflare_api_token = ${CLOUDFLARE_API_TOKEN}" > /etc/letsencrypt/cloudflare/cloudflare.ini
    chmod 600 /etc/letsencrypt/cloudflare/cloudflare.ini
    check_success
    echo -e "${YELLOW}--> æ­¥éª¤ 4.2: ä½¿ç”¨ Certbot (dns-cloudflareæ’ä»¶) ç”³è¯· SSL è¯ä¹¦...${NC}"
    echo -e "${YELLOW}è¿™å¯èƒ½éœ€è¦ä¸€ä¸¤åˆ†é’Ÿï¼Œå› ä¸ºéœ€è¦ç­‰å¾…DNSè®°å½•å…¨çƒç”Ÿæ•ˆ...${NC}"
    certbot certonly \
      --dns-cloudflare \
      --dns-cloudflare-credentials /etc/letsencrypt/cloudflare/cloudflare.ini \
      -d "${DOMAIN_NAME}" \
      --agree-tos \
      --email "${EMAIL}" \
      --non-interactive
    if [ $? -ne 0 ]; then
        echo -e "${RED}é”™è¯¯: SSLè¯ä¹¦ç”³è¯·å¤±è´¥ï¼${NC}"
        echo -e "${RED}è¯·æ£€æŸ¥: 1. ä½ çš„åŸŸåDNSæ˜¯å¦ç”±Cloudflareç®¡ç†ã€‚ 2. API Tokenæ˜¯å¦æ­£ç¡®ä¸”æœ‰æƒé™ã€‚ 3. åŸŸåæ˜¯å¦è¾“å…¥æ­£ç¡®ã€‚${NC}"
        echo -e "${RED}åŒæ—¶è¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ /var/log/letsencrypt/letsencrypt.log è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚${NC}"
        exit 1
    fi

    echo -e "${YELLOW}--> æ­¥éª¤ 4.3: é…ç½®æœ€ç»ˆçš„ Nginx ç«™ç‚¹ (åŒ…å«IPè®¿é—®æ‹¦æˆª)...${NC}"
    # ã€ä¿®æ”¹ã€‘ä¸‹é¢çš„ Nginx é…ç½®å¢åŠ äº†ç¬¬ä¸€ä¸ª server å—ï¼Œç”¨äºæ‹¦æˆª IP è®¿é—®
    cat <<EOF > /etc/nginx/sites-available/vaultwarden.conf
# ----------------------------------------------------------
# ã€æ–°ã€‘æ‹¦æˆªæ‰€æœ‰é€šè¿‡ IP åœ°å€å¯¹ ${HTTPS_PORT} ç«¯å£çš„ HTTPS è®¿é—®
# ----------------------------------------------------------
server {
    listen ${HTTPS_PORT} ssl http2 default_server;
    listen [::]:${HTTPS_PORT} ssl http2 default_server;

    # server_name _ æ•è·æ‰€æœ‰æœªåŒ¹é…åˆ°å…¶ä»– server_name çš„è¯·æ±‚
    server_name _;

    # å¿…é¡»æä¾›è¯ä¹¦æ‰èƒ½åœ¨ SSL æ¨¡å¼ä¸‹ç›‘å¬ï¼Œæˆ‘ä»¬å€Ÿç”¨ä¸»åŸŸåçš„è¯ä¹¦
    ssl_certificate /etc/letsencrypt/live/${DOMAIN_NAME}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${DOMAIN_NAME}/privkey.pem;

    # è¿”å› 444ï¼ŒNginxä¼šç›´æ¥å…³é—­è¿æ¥ï¼Œä¸ç»™æ”»å‡»è€…ä»»ä½•å“åº”
    return 444;
}

# ----------------------------------------------------------
# HTTP -> HTTPS é‡å®šå‘å— (8081 -> 8443)
# ----------------------------------------------------------
server {
    listen ${HTTP_PORT};
    server_name ${DOMAIN_NAME};
    location / {
        # æ³¨æ„ Nginx å˜é‡å‰çš„åæ–œæ ï¼Œé˜²æ­¢ shell æå‰è§£æ
        return 301 https://\$host:${HTTPS_PORT}\$request_uri;
    }
}

# ----------------------------------------------------------
# Vaultwarden çš„ä¸»æœåŠ¡å—
# ----------------------------------------------------------
server {
    listen ${HTTPS_PORT} ssl http2;
    server_name ${DOMAIN_NAME};

    ssl_certificate /etc/letsencrypt/live/${DOMAIN_NAME}/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/${DOMAIN_NAME}/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }

    location /notifications/hub {
        proxy_pass http://127.0.0.1:3012;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
EOF
    check_success

    rm -f /etc/nginx/sites-enabled/default
    ln -sfn /etc/nginx/sites-available/vaultwarden.conf /etc/nginx/sites-enabled/
    
    nginx -t && systemctl reload nginx
    check_success
    echo -e "${GREEN}>>> Nginx å’Œ SSL é…ç½®å®Œæˆã€‚Vaultwardenç°åœ¨ç›‘å¬åœ¨ç«¯å£ ${HTTP_PORT}(http) å’Œ ${HTTPS_PORT}(https)ã€‚${NC}"
}

show_final_info() {
    echo -e "===================================================================="
    echo -e "${GREEN}ğŸ‰ æ­å–œï¼Vaultwarden éƒ¨ç½²å®Œæˆï¼(DNS-01 & Snap Certbot) ğŸ‰${NC}"
    echo -e "===================================================================="
    echo -e "${YELLOW}ä½ çš„ Vaultwarden è®¿é—®åœ°å€æ˜¯:${NC} https://${DOMAIN_NAME}:${HTTPS_PORT}"
    echo ""
    echo -e "${YELLOW}ä½ çš„ç®¡ç†å‘˜åå°è®¿é—®ä»¤ç‰Œ (Admin Token) å·²ä¿å­˜åœ¨æ–‡ä»¶ /opt/vaultwarden/.env ä¸­ã€‚${NC}"
    echo -e "è¯·ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š"
    echo -e "  ${GREEN}sudo cat /opt/vaultwarden/.env${NC}"
    echo ""
    echo -e "${RED}é‡è¦æç¤º:${NC}"
    echo -e "1. 80å’Œ443ç«¯å£æœªè¢«å ç”¨ï¼Œä½ å¯ä»¥ç”¨äºå…¶ä»–æœåŠ¡ã€‚"
    echo -e "2. SSLè¯ä¹¦å°†é€šè¿‡DNSæ–¹å¼è‡ªåŠ¨ç»­è®¢ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚"
    echo -e "3. è¯·ç¡®ä¿ä½ çš„é˜²ç«å¢™å·²æ”¾è¡Œä½ è‡ªå®šä¹‰çš„ç«¯å£: ${GREEN}${HTTP_PORT}${NC} å’Œ ${GREEN}${HTTPS_PORT}${NC}"
    echo -e "  - å¦‚æœä½¿ç”¨ UFW, è¯·è¿è¡Œ: sudo ufw allow ${HTTP_PORT} && sudo ufw allow ${HTTPS_PORT}"
    echo -e "4. å®šæœŸå¤‡ä»½ /opt/vaultwarden/vw-data ç›®å½•ï¼"
    echo -e "5. Nginx å·²é…ç½®ä¸ºæ‹’ç»é€šè¿‡ IP åœ°å€ç›´æ¥è®¿é—®ï¼Œæå‡å®‰å…¨æ€§ã€‚"
    echo -e "===================================================================="
}

main() {
    check_root
    install_dependencies
    get_user_input
    setup_vaultwarden
    setup_nginx_ssl
    show_final_info
}

# --- æ‰§è¡Œè„šæœ¬ ---
main
